<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GeoAgro Quiz BR ‚Äî Edi√ß√£o 2024</title>
  <style>
    :root{
      --bg0:#070a16;
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --stroke:rgba(255,255,255,.13);
      --shadow: 0 14px 34px rgba(0,0,0,.40);
      --r1:18px; --r2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;

      /* Multicolor suave (rosa ‚Üí lil√°s ‚Üí azul ‚Üí ciano) */
      --p1:#fb7185; /* rose */
      --p2:#a78bfa; /* lilac */
      --p3:#60a5fa; /* blue */
      --p4:#22d3ee; /* cyan */
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(251,113,133,.25), transparent 55%),
        radial-gradient(1000px 600px at 90% 15%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 30% 95%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, #090c18, #070a16 60%, #060812);
      overflow-x:hidden;
    }

    .wrap{max-width: 1020px; margin:0 auto; padding:18px 14px 26px;}

    .hero{
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(251,113,133,.16), rgba(167,139,250,.12), rgba(96,165,250,.12));
      border-radius: var(--r1);
      padding: 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(680px 240px at 20% 0%, rgba(251,113,133,.25), transparent 55%),
        radial-gradient(520px 220px at 85% 0%, rgba(96,165,250,.25), transparent 55%);
      pointer-events:none;
      opacity:.85;
    }
    .hero > *{position:relative}

    h1{margin:0; font-size:22px; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--muted);
    }
    .sub{margin:8px 0 0; color:var(--muted); line-height:1.45; font-size:13px}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--r1);
      padding: 14px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card.color:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(600px 260px at 0% 0%, rgba(167,139,250,.16), transparent 55%),
                  radial-gradient(520px 240px at 90% 10%, rgba(34,211,238,.14), transparent 55%);
      pointer-events:none;
    }
    .card > *{position:relative}

    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    .k{
      flex: 1 1 140px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--r2);
      padding: 10px 10px 8px;
      min-width: 140px;
    }
    .k:nth-child(1){background: linear-gradient(135deg, rgba(251,113,133,.12), rgba(255,255,255,.04));}
    .k:nth-child(2){background: linear-gradient(135deg, rgba(167,139,250,.12), rgba(255,255,255,.04));}
    .k:nth-child(3){background: linear-gradient(135deg, rgba(96,165,250,.12), rgba(255,255,255,.04));}
    .k:nth-child(4){background: linear-gradient(135deg, rgba(34,211,238,.12), rgba(255,255,255,.04));}

    .k .t{font-size:11px;color:var(--muted)}
    .k .v{font-size:18px;font-weight:850;margin-top:4px}
    .k .s{font-size:11px;color:var(--muted); margin-top:2px}

    .qhead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px}
    .qmeta{color:var(--muted);font-size:12px}
    .qtitle{font-size: 18px; font-weight: 900; margin: 10px 0 0; line-height: 1.25}

    .bar{
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(251,113,133,.9), rgba(167,139,250,.9), rgba(96,165,250,.9), rgba(34,211,238,.9));
      transition: width .25s ease;
    }

    .answers{display:grid; gap:10px; margin-top: 12px;}
    .ans{
      display:flex; gap:10px; align-items:flex-start;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .ans:hover{background: rgba(255,255,255,.10)}
    .ans:active{transform: translateY(1px)}
    .ans .key{
      width: 32px; height: 32px;
      border-radius: 11px;
      border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      background: linear-gradient(135deg, rgba(251,113,133,.14), rgba(96,165,250,.12));
      flex: 0 0 auto;
    }
    .ans.good{border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.12);}
    .ans.bad{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.10);}
    .ans .txt{line-height:1.25; font-weight: 700;}

    .feedback{
      margin-top: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--r2);
      padding: 12px;
      color: var(--muted);
      line-height:1.45;
      display:none;
    }
    .feedback.show{display:block}
    .tag{
      display:inline-flex;
      padding: 4px 9px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:900;
      font-size:12px;
      margin-right: 8px;
    }

    .opts{display:grid; gap:10px; margin-top:10px}
    .optline{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }
    .pill b{color:var(--text); font-weight:900}

    input, select, button{font-family:inherit}
    input[type="text"]{
      flex:1; min-width:180px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    select{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.12)}
    button:active{transform: translateY(1px)}
    button.primary{
      border-color: rgba(96,165,250,.55);
      background: linear-gradient(135deg, rgba(251,113,133,.25), rgba(96,165,250,.22));
    }
    button.ghost{background: rgba(255,255,255,.05)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none !important}

    .chk{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      user-select:none;
    }
    .chk input{transform: scale(1.12)}

    .footrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:space-between}
    .hint{color: var(--muted); font-size: 12px}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,14,26,.85);
      border:1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 50;
      max-width: min(720px, calc(100vw - 22px));
      text-align:center;
      font-size: 13px;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}

    footer{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      opacity:.95;
    }
    footer b{color:var(--text)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="hero">
    <div class="row" style="justify-content:space-between; gap:12px;">
      <h1>GeoAgro Quiz BR üáßüá∑</h1>
      <span class="badge">Atalhos: <b>1‚Äì4</b> responde ¬∑ <b>Enter</b> pr√≥xima ¬∑ <b>R</b> reinicia</span>
    </div>
    <p class="sub">
      Quiz de geografia, agro, pecu√°ria, popula√ß√£o e indicadores. Banco expans√≠vel (voc√™ s√≥ cola mais perguntas).
      <br><span style="opacity:.9">Edi√ß√£o de dados: <b>2024</b> (rodap√©).</span>
    </p>

    <div class="kpi">
      <div class="k">
        <div class="t">Jogador</div>
        <div class="v" id="kPlayer">Visitante</div>
        <div class="s">salvo no aparelho</div>
      </div>
      <div class="k">
        <div class="t">Melhor</div>
        <div class="v" id="kBest">0</div>
        <div class="s">recorde do jogador</div>
      </div>
      <div class="k">
        <div class="t">Melhor sequ√™ncia</div>
        <div class="v" id="kStreakBest">0</div>
        <div class="s">acertos seguidos (recorde)</div>
      </div>
      <div class="k">
        <div class="t">Banco</div>
        <div class="v" id="kBank">0</div>
        <div class="s">perguntas totais</div>
      </div>
    </div>
  </div>

  <div class="grid">

    <div class="card color">
      <div class="qhead">
        <div class="qmeta"><span id="qProg">0/0</span> &nbsp; <span id="qCat">Categoria: ‚Äî</span></div>
        <div class="qmeta" id="qTimer">‚è≥ ‚Äî</div>
      </div>
      <div class="bar"><div id="barFill"></div></div>

      <div class="qtitle" id="qText">Clique em <b>Come√ßar</b> para iniciar üôÇ</div>

      <div class="answers" id="ansWrap" style="opacity:.7; pointer-events:none;">
        <div class="ans"><div class="key">1</div><div class="txt">‚Äî</div></div>
        <div class="ans"><div class="key">2</div><div class="txt">‚Äî</div></div>
        <div class="ans"><div class="key">3</div><div class="txt">‚Äî</div></div>
        <div class="ans"><div class="key">4</div><div class="txt">‚Äî</div></div>
      </div>

      <div class="feedback" id="fb"></div>

      <div class="footrow">
        <div class="row" style="gap:10px;">
          <button class="ghost" id="btnExplain" disabled>Explicar</button>
          <button class="ghost" id="btnNext" disabled>Pr√≥xima ‚Üí</button>
        </div>
        <div class="hint" id="hint">Dica: responda com 1‚Äì4. Enter avan√ßa.</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:950">Configura√ß√µes</div>
        <button class="ghost" id="btnReset">Resetar rodada</button>
      </div>

      <div class="opts">
        <div class="optline">
          <div class="pill">Nome: <b id="nameLabel">Visitante</b></div>
          <input id="playerName" type="text" placeholder="Digite seu nome (ex: Ernandes)">
          <button class="ghost" id="btnSaveName">Salvar</button>
        </div>

        <label class="chk"><input id="chkShuffleQ" type="checkbox" checked> Embaralhar perguntas</label>
        <label class="chk"><input id="chkShuffleA" type="checkbox" checked> Embaralhar alternativas</label>
        <label class="chk"><input id="chkTrain" type="checkbox" checked> Modo treino (feedback imediato)</label>

        <div class="optline">
          <div class="pill">Quantidade: <b id="nLabel">10</b></div>
          <select id="selN">
            <option value="2">2 perguntas</option>
            <option value="5">5 perguntas</option>
            <option value="10" selected>10 perguntas</option>
            <option value="25">25 perguntas</option>
          </select>
        </div>

        <div class="optline">
          <div class="pill">Tempo: <b id="tLabel">Sem limite</b></div>
          <select id="selT">
            <option value="0" selected>Sem limite</option>
            <option value="300">5 min</option>
            <option value="600">10 min</option>
          </select>
        </div>

        <button class="primary" id="btnStart">Come√ßar / Reiniciar</button>

        <div class="pill" style="justify-content:space-between;">
          <span>Voc√™ vs voc√™ mesmo</span>
          <b id="deltaLabel">‚Äî</b>
        </div>

        <div style="color:var(--muted); font-size:12px; line-height:1.35">
          As conquistas s√£o salvas por nome (localStorage). Troque o nome para ter perfis diferentes.
        </div>
      </div>
    </div>

  </div>

  <footer>
    <div><b>GeoAgro Quiz BR</b> ‚Äî Edi√ß√£o de dados <b>2024</b></div>
    <div>Autor: <b>Ernandes Junior</b> ¬∑ armazenamento local (localStorage)</div>
  </footer>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // ===== Utils =====
  const $ = (id) => document.getElementById(id);

  const toastEl = $("toast");
  let toastT = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastT);
    toastT = setTimeout(()=>toastEl.classList.remove("show"), 1700);
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function pickN(arr, n){
    const copy = arr.slice();
    shuffle(copy);
    return copy.slice(0, n);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // ===== UI =====
  const ui = {
    kPlayer: $("kPlayer"),
    kBest: $("kBest"),
    kStreakBest: $("kStreakBest"),
    kBank: $("kBank"),

    qProg: $("qProg"),
    qCat: $("qCat"),
    qText: $("qText"),
    ansWrap: $("ansWrap"),
    fb: $("fb"),
    barFill: $("barFill"),
    qTimer: $("qTimer"),

    btnExplain: $("btnExplain"),
    btnNext: $("btnNext"),
    btnStart: $("btnStart"),
    btnReset: $("btnReset"),

    chkShuffleQ: $("chkShuffleQ"),
    chkShuffleA: $("chkShuffleA"),
    chkTrain: $("chkTrain"),

    selN: $("selN"),
    selT: $("selT"),
    nLabel: $("nLabel"),
    tLabel: $("tLabel"),
    hint: $("hint"),

    playerName: $("playerName"),
    btnSaveName: $("btnSaveName"),
    nameLabel: $("nameLabel"),

    deltaLabel: $("deltaLabel"),
  };

  // ===== Perfis (localStorage por nome) =====
  const PROFILES_KEY = "geoagro_quiz_profiles_v1";
  const ACTIVE_KEY   = "geoagro_quiz_active_player_v1";

  function loadProfiles(){
    try { return JSON.parse(localStorage.getItem(PROFILES_KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveProfiles(p){
    localStorage.setItem(PROFILES_KEY, JSON.stringify(p));
  }
  function getActiveName(){
    return (localStorage.getItem(ACTIVE_KEY) || "").trim();
  }
  function setActiveName(name){
    localStorage.setItem(ACTIVE_KEY, name.trim());
  }

  let profiles = loadProfiles();

  function ensureProfile(name){
    if(!profiles[name]){
      profiles[name] = { best: 0, streakBest: 0, lastScore: 0, lastTotal: 0 };
    }
    return profiles[name];
  }

  let activeName = getActiveName() || "Visitante";
  ensureProfile(activeName);
  saveProfiles(profiles);

  function refreshPlayerUI(){
    const p = ensureProfile(activeName);
    ui.kPlayer.textContent = activeName;
    ui.nameLabel.textContent = activeName;
    ui.kBest.textContent = String(p.best);
    ui.kStreakBest.textContent = String(p.streakBest);
    ui.deltaLabel.textContent = (p.lastTotal > 0)
      ? `√öltima: ${p.lastScore}/${p.lastTotal}`
      : "‚Äî";
  }

  function setPlayer(raw){
    const name = (raw || "").trim();
    activeName = name ? name : "Visitante";
    ensureProfile(activeName);
    setActiveName(activeName);
    saveProfiles(profiles);

    ui.playerName.value = (activeName === "Visitante") ? "" : activeName;
    refreshPlayerUI();
    toast("Jogador: " + activeName);
  }

  // Listeners de nome (uma vez s√≥)
  ui.btnSaveName.addEventListener("click", () => setPlayer(ui.playerName.value));
  ui.playerName.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      setPlayer(ui.playerName.value);
    }
  });

  // ===== Banco de perguntas =====
  const bank = [];
  function addQ(id, cat, q, a, correct, exp, src){
    if(!Array.isArray(a) || a.length !== 4) throw new Error("Quest√£o sem 4 alternativas: " + id);
    bank.push({ id, cat, q, a, correct, exp, src });
  }

  // >>>>>>> COLE O PACOT√ÉO AQUI (depois) <<<<<<<
  // Por enquanto s√≥ 2 perguntas:
  addQ("Q1","Capitais","Qual √© a capital do Amap√°?",
    ["Macap√°","Bel√©m","Boa Vista","Rio Branco"], 0,
    "A capital do Amap√° √© Macap√°.",
    "Fonte: geografia pol√≠tica do Brasil."
  );
  addQ("Q2","Agro (MT)","Qual √© a principal produ√ß√£o agr√≠cola do Mato Grosso (s√©ries recentes)?",
    ["Soja","Uva","Cacau","Ma√ß√£"], 0,
    "Mato Grosso √© l√≠der nacional em soja em s√©ries recentes.",
    "Fonte: IBGE ‚Äî PAM (s√©ries recentes)."
  );

  ui.kBank.textContent = String(bank.length);

  // ===== Runtime do quiz =====
  let deck = [];
  let idx = -1;
  let answered = false;
  let score = 0;
  let streak = 0;

  // timer
  let timeLimit = 0;
  let timeLeft = 0;
  let timerInt = null;

  function updateLabels(){
    ui.nLabel.textContent = ui.selN.value;
    const t = Number(ui.selT.value);
    ui.tLabel.textContent = (t === 0) ? "Sem limite" : `${Math.round(t/60)} min`;
    ui.hint.textContent = ui.chkTrain.checked
      ? "Modo treino: feedback imediato."
      : "Modo prova: feedback s√≥ ap√≥s responder.";
  }
  ui.selN.addEventListener("change", updateLabels);
  ui.selT.addEventListener("change", updateLabels);
  ui.chkTrain.addEventListener("change", updateLabels);
  updateLabels();

  function stopTimer(){
    if(timerInt){ clearInterval(timerInt); timerInt = null; }
  }
  function fmtTime(s){
    const m = Math.floor(s/60);
    const r = s%60;
    return String(m).padStart(2,"0")+":"+String(r).padStart(2,"0");
  }
  function startTimer(){
    stopTimer();
    if(timeLimit <= 0){
      ui.qTimer.textContent = "‚è≥ Sem limite";
      return;
    }
    ui.qTimer.textContent = "‚è≥ " + fmtTime(timeLeft);
    timerInt = setInterval(() => {
      timeLeft = Math.max(0, timeLeft - 1);
      ui.qTimer.textContent = "‚è≥ " + fmtTime(timeLeft);
      if(timeLeft <= 0){
        stopTimer();
        finishQuiz(true);
      }
    }, 1000);
  }

  function render(){
    const total = deck.length;

    if(idx < 0 || idx >= total){
      ui.qProg.textContent = "0/0";
      ui.qCat.textContent = "Categoria: ‚Äî";
      ui.barFill.style.width = "0%";
      ui.qText.innerHTML = 'Clique em <b>Come√ßar</b> para iniciar üôÇ';
      ui.ansWrap.style.opacity = ".7";
      ui.ansWrap.style.pointerEvents = "none";
      ui.fb.classList.remove("show");
      ui.fb.innerHTML = "";
      ui.btnExplain.disabled = true;
      ui.btnNext.disabled = true;
      ui.qTimer.textContent = "‚è≥ ‚Äî";
      return;
    }

    const q = deck[idx];
    ui.qProg.textContent = (idx+1) + "/" + total;
    ui.qCat.textContent = "Categoria: " + q.cat;
    ui.barFill.style.width = ((idx+1)/total*100).toFixed(1) + "%";
    ui.qText.textContent = q.q;

    ui.ansWrap.innerHTML = "";
    q.a.forEach((txt, i) => {
      const el = document.createElement("div");
      el.className = "ans";
      el.innerHTML = `<div class="key">${i+1}</div><div class="txt">${escapeHtml(txt)}</div>`;
      el.addEventListener("click", () => choose(i));
      ui.ansWrap.appendChild(el);
    });

    ui.ansWrap.style.opacity = "1";
    ui.ansWrap.style.pointerEvents = "auto";
    ui.fb.classList.remove("show");
    ui.fb.innerHTML = "";
    answered = false;
    ui.btnExplain.disabled = true;
    ui.btnNext.disabled = true;
  }

  function showFeedback(isCorrect){
    const q = deck[idx];
    const tag = isCorrect
      ? `<span class="tag" style="border-color:rgba(52,211,153,.55)">‚úÖ Acertou</span>`
      : `<span class="tag" style="border-color:rgba(251,113,133,.55)">‚ùå Errou</span>`;

    ui.fb.innerHTML = `
      ${tag}
      <b>Resposta:</b> ${escapeHtml(q.a[q.correct])}<br>
      <b>Explica√ß√£o:</b> ${escapeHtml(q.exp)}<br>
      <span style="opacity:.95; font-size:12px"><b>Fonte:</b> ${escapeHtml(q.src)}</span>
    `;
    ui.fb.classList.add("show");
  }

  function choose(i){
    if(idx < 0 || idx >= deck.length){
      toast("Clique em Come√ßar üôÇ");
      return;
    }
    if(answered){
      toast("J√° respondeu. Enter ‚Üí pr√≥xima.");
      return;
    }
    const q = deck[idx];
    answered = true;

    const isCorrect = (i === q.correct);
    if(isCorrect){ score++; streak++; }
    else{ streak = 0; }

    const items = Array.from(ui.ansWrap.querySelectorAll(".ans"));
    items.forEach((el, k) => {
      if(k === q.correct) el.classList.add("good");
      else if(k === i) el.classList.add("bad");
    });

    ui.btnNext.disabled = false;
    ui.btnExplain.disabled = false;

    if(ui.chkTrain.checked){
      showFeedback(isCorrect);
    }else{
      showFeedback(isCorrect); // voc√™ pode esconder no modo prova se quiser
    }
  }

  function explain(){
    if(idx < 0 || idx >= deck.length){ toast("Ainda n√£o come√ßou üôÇ"); return; }
    if(!answered){ toast("Responda primeiro üôÇ"); return; }
    ui.fb.scrollIntoView({behavior:"smooth", block:"nearest"});
  }

  function next(){
    if(idx < 0 || idx >= deck.length){ toast("Clique em Come√ßar üôÇ"); return; }
    if(!answered){ toast("Responda antes de avan√ßar üôÇ"); return; }
    if(idx === deck.length - 1){ finishQuiz(false); return; }
    idx++;
    render();
  }

  function finishQuiz(byTime){
    stopTimer();
    const total = deck.length;
    const pct = total ? Math.round(score/total*100) : 0;

    const p = ensureProfile(activeName);
    p.lastScore = score;
    p.lastTotal = total;
    if(score > p.best) p.best = score;
    if(streak > p.streakBest) p.streakBest = streak;

    saveProfiles(profiles);
    refreshPlayerUI();

    ui.qText.innerHTML = byTime
      ? `‚è∞ Tempo! Voc√™ fez <b>${score}/${total}</b> (${pct}%).`
      : `üéâ Fim! Voc√™ fez <b>${score}/${total}</b> (${pct}%).`;

    ui.qCat.textContent = "Categoria: Resultado";
    ui.qProg.textContent = total + "/" + total;
    ui.barFill.style.width = "100%";

    ui.ansWrap.style.opacity = ".85";
    ui.ansWrap.style.pointerEvents = "none";
    ui.btnNext.disabled = true;
    ui.btnExplain.disabled = true;

    ui.fb.innerHTML = `
      <span class="tag">üìå Resumo</span>
      <b>Jogador:</b> ${escapeHtml(activeName)}<br>
      <b>Pontua√ß√£o:</b> ${score}/${total} (${pct}%)<br>
      <b>Recorde:</b> ${p.best}<br>
      <b>Melhor sequ√™ncia (recorde):</b> ${p.streakBest}<br>
      <span style="opacity:.95; font-size:12px">Dica: mude quantidade/tempo e clique em ‚ÄúCome√ßar / Reiniciar‚Äù.</span>
    `;
    ui.fb.classList.add("show");
  }

  function buildDeck(){
    if(bank.length === 0){
      toast("Banco vazio üôÉ");
      return;
    }
    const N = clamp(parseInt(ui.selN.value,10) || 10, 1, bank.length);
    const shuffleQ = ui.chkShuffleQ.checked;
    const shuffleA = ui.chkShuffleA.checked;

    let chosen = shuffleQ ? pickN(bank, N) : bank.slice(0, N);

    chosen = chosen.map(q => {
      const qq = { ...q, a: q.a.slice(), correct: q.correct };
      if(shuffleA){
        const zipped = qq.a.map((txt, i) => ({ txt, i }));
        shuffle(zipped);
        qq.a = zipped.map(z => z.txt);
        qq.correct = zipped.findIndex(z => z.i === q.correct);
      }
      return qq;
    });

    deck = chosen;
    idx = 0;
    answered = false;
    score = 0;
    streak = 0;

    timeLimit = parseInt(ui.selT.value,10) || 0;
    timeLeft = timeLimit;
    startTimer();

    render();
    toast("Valendo! üòÑ");
  }

  function resetRound(){
    stopTimer();
    deck = [];
    idx = -1;
    answered = false;
    score = 0;
    streak = 0;
    ui.fb.classList.remove("show");
    ui.fb.innerHTML = "";
    render();
    toast("Rodada resetada üôÇ");
  }

  // Bot√µes (uma vez s√≥)
  ui.btnStart.addEventListener("click", buildDeck);
  ui.btnReset.addEventListener("click", resetRound);
  ui.btnExplain.addEventListener("click", explain);
  ui.btnNext.addEventListener("click", next);

  // Teclado
  window.addEventListener("keydown", (ev) => {
    if(ev.key === "1") choose(0);
    if(ev.key === "2") choose(1);
    if(ev.key === "3") choose(2);
    if(ev.key === "4") choose(3);
    if(ev.key === "Enter") next();
    if(ev.key.toLowerCase() === "r") buildDeck();
  });

  // init
  ui.playerName.value = (activeName === "Visitante") ? "" : activeName;
  refreshPlayerUI();
  render();
})();
</script>
</body>
</html>
