<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GeoAgro Quiz BR ‚Äî Edi√ß√£o 2024</title>

  <style>
    :root{
      --bg0:#070A14;
      --bg1:#0B1020;

      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);

      --text:#EEF2FF;
      --muted: rgba(238,242,255,.72);

      --good: #34d399;
      --bad:  #fb7185;

      /* Paleta jovial rosa -> azul */
      --p1:#fb7185; /* rose */
      --p2:#f472b6; /* pink */
      --p3:#a78bfa; /* lilac */
      --p4:#60a5fa; /* blue */
      --p5:#22d3ee; /* cyan */

      --shadow: 0 16px 40px rgba(0,0,0,.42);
      --radius: 18px;
      --radius2: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(244,114,182,.25), transparent 55%),
        radial-gradient(1000px 600px at 90% 15%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 30% 95%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 520px at 85% 90%, rgba(251,113,133,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 68%, #050812);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    .hero{
      border:1px solid var(--stroke);
      background: linear-gradient(135deg,
        rgba(251,113,133,.14),
        rgba(244,114,182,.12),
        rgba(167,139,250,.12),
        rgba(96,165,250,.12));
      border-radius: var(--radius);
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(640px 240px at 18% 10%, rgba(251,113,133,.28), transparent 58%),
        radial-gradient(640px 260px at 60% 0%, rgba(167,139,250,.22), transparent 60%),
        radial-gradient(540px 220px at 90% 10%, rgba(96,165,250,.22), transparent 60%);
      pointer-events:none;
      opacity:.95;
    }
    .hero > *{position:relative}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .between{justify-content:space-between}

    h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
      line-height:1.1;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .badge b{color:var(--text)}

    .sub{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.45;
      font-size: 13px;
      max-width: 980px;
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 900px){
      .kpi{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }

    .k{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius2);
      padding: 10px 10px 8px;
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
      position:relative;
      overflow:hidden;
    }
    .k:before{
      content:"";
      position:absolute; inset:-1px;
      background: linear-gradient(90deg,
        rgba(251,113,133,.14),
        rgba(244,114,182,.10),
        rgba(96,165,250,.12));
      opacity:.8;
      pointer-events:none;
    }
    .k > *{position:relative}
    .k .t{font-size:11px;color:var(--muted)}
    .k .v{font-size:18px;font-weight:900;margin-top:4px}
    .k .s{font-size:11px;color:var(--muted); margin-top:2px}

    .grid{
      display:grid;
      grid-template-columns: 1.18fr .82fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      width: fit-content;
    }
    .pill b{color:var(--text); font-weight:800}

    .qhead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .qmeta{color:var(--muted);font-size:12px}

    .bar{
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg,
        rgba(251,113,133,.95),
        rgba(244,114,182,.95),
        rgba(167,139,250,.95),
        rgba(96,165,250,.95),
        rgba(34,211,238,.95));
      transition: width .25s ease;
    }

    .qtitle{
      font-size: 18px;
      font-weight: 900;
      margin: 12px 0 0;
      line-height: 1.25;
      text-shadow: 0 10px 28px rgba(0,0,0,.25);
    }

    .answers{display:grid; gap:10px; margin-top: 12px;}
    .ans{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .ans:before{
      content:"";
      position:absolute; inset:-1px;
      background: linear-gradient(90deg,
        rgba(251,113,133,.10),
        rgba(96,165,250,.08),
        rgba(34,211,238,.08));
      opacity:.85;
      pointer-events:none;
    }
    .ans > *{position:relative}
    .ans:hover{background: rgba(255,255,255,.09); box-shadow: 0 10px 22px rgba(0,0,0,.18)}
    .ans:active{transform: translateY(1px)}
    .ans .key{
      width: 32px; height: 32px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      font-weight:950;
      background: rgba(0,0,0,.10);
      flex: 0 0 auto;
    }
    .ans.good{border-color: rgba(52,211,153,.65); background: rgba(52,211,153,.14);}
    .ans.bad{border-color: rgba(251,113,133,.70); background: rgba(251,113,133,.14);}

    .feedback{
      margin-top: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--radius2);
      padding: 12px;
      color: var(--muted);
      line-height:1.45;
      display:none;
    }
    .feedback.show{display:block}
    .feedback .tag{
      display:inline-flex;
      padding: 4px 9px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:900;
      font-size:12px;
      margin-right: 8px;
    }

    .footrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
      justify-content:space-between;
    }
    .hint{color: var(--muted); font-size: 12px;}

    input, select, button{font-family:inherit}
    input[type="text"], select{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      width: 100%;
    }

    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 14px;
      font-weight: 850;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.11)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none !important;}

    button.primary{
      border-color: rgba(244,114,182,.55);
      background: linear-gradient(135deg,
        rgba(251,113,133,.25),
        rgba(244,114,182,.18),
        rgba(96,165,250,.18));
    }
    button.ghost{background: rgba(255,255,255,.05);}

    .chk{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--muted);
      user-select:none;
    }
    .chk input{transform: scale(1.1)}

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,14,26,.88);
      border:1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 50;
      max-width: min(720px, calc(100vw - 22px));
      text-align:center;
      font-size: 13px;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}

    footer{
      margin-top: 16px;
      text-align:center;
      color: rgba(238,242,255,.60);
      font-size: 12px;
    }
    .small{font-size:11px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="row between" style="gap:12px;">
        <h1>GeoAgro Quiz BR <span class="small">‚ú® (multi-ano)</span></h1>
        <span class="badge">Atalhos: <b>1‚Äì4</b> responde ¬∑ <b>Enter</b> pr√≥xima ¬∑ <b>R</b> reinicia</span>
      </div>

      <p class="sub">
        Quiz de geografia + agro + pecu√°ria + popula√ß√£o + indicadores.
        Banco expans√≠vel (voc√™ cola mais perguntas). <br>
        <span class="small">Edi√ß√£o de dados: <b>2024</b> (rodap√©). Perfis e recordes ficam no seu aparelho (localStorage).</span>
      </p>

      <div class="kpi">
        <div class="k"><div class="t">Jogador</div><div class="v" id="kPlayer">Visitante</div><div class="s">salvo no aparelho</div></div>
        <div class="k"><div class="t">Melhor</div><div class="v" id="kBest">0</div><div class="s">recorde do jogador</div></div>
        <div class="k"><div class="t">Melhor sequ√™ncia</div><div class="v" id="kStreakBest">0</div><div class="s">acertos seguidos (recorde)</div></div>
        <div class="k"><div class="t">Banco</div><div class="v" id="kBank">0</div><div class="s">perguntas totais</div></div>
      </div>
    </div>

    <div class="grid">

      <!-- QUIZ -->
      <div class="card">
        <div class="qhead">
          <div class="qmeta"><span id="qProg">0/0</span> &nbsp; <span id="qCat">Categoria: ‚Äî</span></div>
          <div class="qmeta" id="qTimer">‚è≥ ‚Äî</div>
        </div>
        <div class="bar"><div id="barFill"></div></div>

        <div class="qtitle" id="qText">Clique em <b>Come√ßar</b> para iniciar üôÇ</div>

        <div class="answers" id="ansWrap" style="opacity:.7; pointer-events:none;">
          <div class="ans"><div class="key">1</div><div class="txt">‚Äî</div></div>
          <div class="ans"><div class="key">2</div><div class="txt">‚Äî</div></div>
          <div class="ans"><div class="key">3</div><div class="txt">‚Äî</div></div>
          <div class="ans"><div class="key">4</div><div class="txt">‚Äî</div></div>
        </div>

        <div class="feedback" id="fb"></div>

        <div class="footrow">
          <div class="row" style="gap:10px;">
            <button class="ghost" id="btnExplain" disabled>Explicar</button>
            <button class="ghost" id="btnNext" disabled>Pr√≥xima ‚Üí</button>
          </div>
          <div class="hint" id="hint">Dica: responda com 1‚Äì4. Enter avan√ßa.</div>
        </div>
      </div>

      <!-- CONFIG -->
      <div class="card">
        <div class="row between">
          <div style="font-weight:950">Configura√ß√µes</div>
          <button class="ghost" id="btnReset">Resetar rodada</button>
        </div>

        <div style="margin-top:10px" class="row" style="align-items:flex-start">
          <div style="flex: 0 0 auto;">
            <div class="pill">Nome: <b id="nameLabel">Visitante</b></div>
          </div>
          <div style="flex:1; min-width:220px">
            <input id="playerName" type="text" placeholder="Digite seu nome (ex: Ernandes)" />
          </div>
          <div style="flex:0 0 auto">
            <button class="ghost" id="btnSaveName">Salvar</button>
          </div>
        </div>

        <div style="margin-top:10px" class="chk"><input id="chkShuffleQ" type="checkbox" checked> Embaralhar perguntas</div>
        <div style="margin-top:10px" class="chk"><input id="chkShuffleA" type="checkbox" checked> Embaralhar alternativas</div>
        <div style="margin-top:10px" class="chk"><input id="chkTrain" type="checkbox" checked> Modo treino (feedback imediato)</div>

        <div style="margin-top:10px" class="row between">
          <div class="pill">Quantidade: <b id="nLabel">10</b></div>
          <select id="selN" style="max-width:220px">
            <option value="2">2 perguntas</option>
            <option value="5">5 perguntas</option>
            <option value="10" selected>10 perguntas</option>
            <option value="25">25 perguntas</option>
            <option value="40">40 perguntas</option>
          </select>
        </div>

        <div style="margin-top:10px" class="row between">
          <div class="pill">Tempo: <b id="tLabel">Sem limite</b></div>
          <select id="selT" style="max-width:220px">
            <option value="0" selected>Sem limite</option>
            <option value="300">5 min</option>
            <option value="600">10 min</option>
            <option value="900">15 min</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <button class="primary" id="btnStart" style="width:100%">Come√ßar / Reiniciar</button>
        </div>

        <div style="margin-top:10px" class="small">
          Voc√™ vs voc√™ mesmo ‚Äî conquistas por nome (localStorage).
          <span style="float:right" id="deltaLabel">‚Äî</span>
        </div>

      </div>

    </div>

    <footer>
      <b>GeoAgro Quiz BR</b> ‚Äî Edi√ß√£o de dados <b>2024</b><br>
      Autor: <b>Ernandes Junior</b> ¬∑ armazenamento local (localStorage)
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (() => {
    "use strict";

    // Erro vis√≠vel (pra voc√™ nunca ficar no escuro)
    window.addEventListener("error", (e) => {
      alert("Erro no JS: " + e.message + "\\n" + (e.filename || "") + ":" + (e.lineno || ""));
    });

    const $ = (id) => document.getElementById(id);

    const ui = {
      toast: $("toast"),

      kPlayer: $("kPlayer"),
      kBest: $("kBest"),
      kStreakBest: $("kStreakBest"),
      kBank: $("kBank"),

      qProg: $("qProg"),
      qCat: $("qCat"),
      qText: $("qText"),
      ansWrap: $("ansWrap"),
      fb: $("fb"),
      barFill: $("barFill"),
      qTimer: $("qTimer"),

      btnExplain: $("btnExplain"),
      btnNext: $("btnNext"),
      btnStart: $("btnStart"),
      btnReset: $("btnReset"),

      chkShuffleQ: $("chkShuffleQ"),
      chkShuffleA: $("chkShuffleA"),
      chkTrain: $("chkTrain"),

      selN: $("selN"),
      selT: $("selT"),
      nLabel: $("nLabel"),
      tLabel: $("tLabel"),
      hint: $("hint"),

      playerName: $("playerName"),
      btnSaveName: $("btnSaveName"),
      nameLabel: $("nameLabel"),
      deltaLabel: $("deltaLabel"),
    };

    for (const [k, el] of Object.entries(ui)) {
      if (!el) throw new Error("Elemento n√£o encontrado: #" + k);
    }

    // ===== toast =====
    let toastT = null;
    function toast(msg){
      ui.toast.textContent = msg;
      ui.toast.classList.add("show");
      clearTimeout(toastT);
      toastT = setTimeout(()=>ui.toast.classList.remove("show"), 1700);
    }

    // ===== utils =====
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
    function pickN(arr,n){
      const copy = arr.slice();
      shuffle(copy);
      return copy.slice(0,n);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ===== perfis =====
    const PROFILES_KEY = "geoagro_quiz_profiles_v2";
    const ACTIVE_KEY   = "geoagro_quiz_active_player_v2";

    function loadProfiles(){
      try { return JSON.parse(localStorage.getItem(PROFILES_KEY) || "{}"); }
      catch(_){ return {}; }
    }
    function saveProfiles(p){ localStorage.setItem(PROFILES_KEY, JSON.stringify(p)); }
    function getActiveName(){ return (localStorage.getItem(ACTIVE_KEY) || "").trim(); }
    function setActiveName(name){ localStorage.setItem(ACTIVE_KEY, name.trim()); }

    let profiles = loadProfiles();
    function ensureProfile(name){
      if(!profiles[name]) profiles[name] = { best:0, streakBest:0, lastScore:0, lastTotal:0 };
      return profiles[name];
    }

    let activeName = getActiveName() || "Visitante";
    ensureProfile(activeName);
    saveProfiles(profiles);

    function refreshPlayerUI(){
      const p = ensureProfile(activeName);
      ui.kPlayer.textContent = activeName;
      ui.nameLabel.textContent = activeName;
      ui.kBest.textContent = String(p.best);
      ui.kStreakBest.textContent = String(p.streakBest);
      ui.deltaLabel.textContent = (p.lastTotal > 0) ? `√öltima: ${p.lastScore}/${p.lastTotal}` : "‚Äî";
    }

    function setPlayer(raw){
      const name = (raw || "").trim();
      activeName = name ? name : "Visitante";
      ensureProfile(activeName);
      setActiveName(activeName);
      saveProfiles(profiles);
      ui.playerName.value = (activeName === "Visitante") ? "" : activeName;
      refreshPlayerUI();
      toast("Jogador: " + activeName);
    }

    ui.btnSaveName.addEventListener("click", () => setPlayer(ui.playerName.value));
    ui.playerName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); setPlayer(ui.playerName.value); }
    });

    // ===== banco =====
    const bank = [];
    function addQ(id, cat, q, a, correct, exp, src){
      if(!Array.isArray(a) || a.length !== 4) throw new Error("Quest√£o sem 4 alternativas: " + id);
      bank.push({ id, cat, q, a, correct, exp, src });
    }

    // 2 perguntas teste
    addQ("Q1","Capitais","Qual √© a capital do Amap√°?",
      ["Macap√°","Bel√©m","Boa Vista","Rio Branco"], 0,
      "A capital do Amap√° √© Macap√°.",
      "Fonte: geografia pol√≠tica do Brasil."
    );
    addQ("Q2","Agro (MT)","Qual √© a principal produ√ß√£o agr√≠cola do Mato Grosso (s√©ries recentes)?",
      ["Soja","Uva","Cacau","Ma√ß√£"], 0,
      "Mato Grosso √© l√≠der nacional em soja em s√©ries recentes.",
      "Fonte: IBGE ‚Äî PAM (s√©ries recentes)."
    );

    // ======= ESPA√áO PARA O PACOT√ÉO =======
    // Cole aqui o seu banco grande, usando addQ(...)
    // Exemplo:
    // addQ("pib1","PIB por UF","Qual UF tem o maior PIB? ", ["SP","RJ","MG","PR"], 0, "Exp...", "Fonte...");

    ui.kBank.textContent = String(bank.length);

    // ===== quiz runtime =====
    let deck = [];
    let idx = -1;
    let answered = false;
    let score = 0;
    let streak = 0;

    // timer simples (s√≥ exibe; se quiser cronometrado de verdade depois, a gente liga)
    function updateLabels(){
      ui.nLabel.textContent = ui.selN.value;
      const t = Number(ui.selT.value);
      ui.tLabel.textContent = (t === 0) ? "Sem limite" : `${Math.round(t/60)} min`;
      ui.hint.textContent = ui.chkTrain.checked ? "Modo treino: feedback imediato." : "Modo prova: feedback ap√≥s responder.";
      ui.qTimer.textContent = (t === 0) ? "‚è≥ Sem limite" : "‚è≥ " + ui.tLabel.textContent;
    }
    ui.selN.addEventListener("change", updateLabels);
    ui.selT.addEventListener("change", updateLabels);
    ui.chkTrain.addEventListener("change", updateLabels);
    updateLabels();

    function render(){
      const total = deck.length;

      if(idx < 0 || idx >= total){
        ui.qProg.textContent = "0/0";
        ui.qCat.textContent = "Categoria: ‚Äî";
        ui.barFill.style.width = "0%";
        ui.qText.innerHTML = 'Clique em <b>Come√ßar</b> para iniciar üôÇ';
        ui.ansWrap.style.opacity = ".7";
        ui.ansWrap.style.pointerEvents = "none";
        ui.fb.classList.remove("show");
        ui.fb.innerHTML = "";
        ui.btnExplain.disabled = true;
        ui.btnNext.disabled = true;
        return;
      }

      const q = deck[idx];
      ui.qProg.textContent = (idx+1) + "/" + total;
      ui.qCat.textContent = "Categoria: " + q.cat;
      ui.barFill.style.width = ((idx+1)/total*100).toFixed(1) + "%";
      ui.qText.textContent = q.q;

      ui.ansWrap.innerHTML = "";
      q.a.forEach((txt, i) => {
        const el = document.createElement("div");
        el.className = "ans";
        el.innerHTML = `<div class="key">${i+1}</div><div class="txt">${escapeHtml(txt)}</div>`;
        el.addEventListener("click", () => choose(i));
        ui.ansWrap.appendChild(el);
      });

      ui.ansWrap.style.opacity = "1";
      ui.ansWrap.style.pointerEvents = "auto";
      ui.fb.classList.remove("show");
      ui.fb.innerHTML = "";
      answered = false;
      ui.btnExplain.disabled = true;
      ui.btnNext.disabled = true;
    }

    function showFeedback(isCorrect){
      const q = deck[idx];
      const tag = isCorrect
        ? `<span class="tag" style="border-color:rgba(52,211,153,.65)">‚úÖ Acertou</span>`
        : `<span class="tag" style="border-color:rgba(251,113,133,.70)">‚ùå Errou</span>`;

      ui.fb.innerHTML = `
        ${tag}
        <b>Resposta:</b> ${escapeHtml(q.a[q.correct])}<br>
        <b>Explica√ß√£o:</b> ${escapeHtml(q.exp)}<br>
        <span class="small"><b>Fonte:</b> ${escapeHtml(q.src)}</span>
      `;
      ui.fb.classList.add("show");
    }

    function choose(i){
      if(idx < 0 || idx >= deck.length){ toast("Clique em Come√ßar üôÇ"); return; }
      if(answered){ toast("J√° respondeu. Enter ‚Üí pr√≥xima."); return; }

      const q = deck[idx];
      answered = true;

      const isCorrect = (i === q.correct);
      if(isCorrect){ score++; streak++; } else { streak = 0; }

      const items = Array.from(ui.ansWrap.querySelectorAll(".ans"));
      items.forEach((el, k) => {
        if(k === q.correct) el.classList.add("good");
        else if(k === i) el.classList.add("bad");
      });

      ui.btnNext.disabled = false;
      ui.btnExplain.disabled = false;

      if(ui.chkTrain.checked) showFeedback(isCorrect);
      else showFeedback(isCorrect); // mant√©m simples (voc√™ pediu explicar sempre)
    }

    function finish(){
      const total = deck.length || 1;
      const pct = Math.round(score/total*100);

      const p = ensureProfile(activeName);
      p.lastScore = score; p.lastTotal = deck.length;
      if(score > p.best) p.best = score;
      if(streak > p.streakBest) p.streakBest = streak;
      saveProfiles(profiles);

      refreshPlayerUI();

      ui.qText.innerHTML = `üéâ Fim! Voc√™ fez <b>${score}/${deck.length}</b> (${pct}%).`;
      ui.qCat.textContent = "Categoria: Resultado";
      ui.qProg.textContent = `${deck.length}/${deck.length}`;
      ui.barFill.style.width = "100%";
      ui.ansWrap.style.pointerEvents = "none";
      ui.btnNext.disabled = true;
      ui.btnExplain.disabled = true;

      ui.fb.innerHTML = `
        <span class="tag">üìå Resumo</span>
        <b>Pontua√ß√£o:</b> ${score}/${deck.length} (${pct}%)<br>
        <b>Melhor (hist√≥rico):</b> ${ensureProfile(activeName).best}<br>
        <b>Melhor sequ√™ncia:</b> ${ensureProfile(activeName).streakBest}<br>
        <span class="small">Dica: troque o nome para perfis diferentes e clique em ‚ÄúCome√ßar / Reiniciar‚Äù.</span>
      `;
      ui.fb.classList.add("show");
    }

    function next(){
      if(idx < 0 || idx >= deck.length){ toast("Clique em Come√ßar üôÇ"); return; }
      if(!answered){ toast("Responda antes de avan√ßar üôÇ"); return; }
      if(idx === deck.length - 1) { finish(); return; }
      idx++;
      render();
    }

    function buildDeck(){
      // se tiver nome digitado, j√° salva (pra n√£o ficar Visitante)
      if ((ui.playerName.value || "").trim()) setPlayer(ui.playerName.value);

      if(bank.length === 0){ toast("Banco vazio üôÉ"); return; }

      const N = clamp(parseInt(ui.selN.value,10) || 10, 1, bank.length);
      const shuffleQ = ui.chkShuffleQ.checked;
      const shuffleA = ui.chkShuffleA.checked;

      let chosen = shuffleQ ? pickN(bank, N) : bank.slice(0, N);

      chosen = chosen.map(q => {
        const qq = { ...q, a: q.a.slice(), correct: q.correct };
        if(shuffleA){
          const zipped = qq.a.map((txt, i) => ({ txt, i }));
          shuffle(zipped);
          qq.a = zipped.map(z => z.txt);
          qq.correct = zipped.findIndex(z => z.i === q.correct);
        }
        return qq;
      });

      deck = chosen;
      idx = 0;
      answered = false;
      score = 0;
      streak = 0;

      toast("Valendo! üòÑ");
      render();
    }

    function resetRound(){
      deck = [];
      idx = -1;
      answered = false;
      score = 0;
      streak = 0;
      render();
      toast("Rodada resetada üôÇ");
    }

    ui.btnStart.addEventListener("click", buildDeck);
    ui.btnReset.addEventListener("click", resetRound);
    ui.btnNext.addEventListener("click", next);
    ui.btnExplain.addEventListener("click", () => {
      if(!answered) toast("Responda primeiro üôÇ");
      else ui.fb.scrollIntoView({behavior:"smooth", block:"nearest"});
    });

    // teclas (SEM toLowerCase pra n√£o quebrar)
    window.addEventListener("keydown", (ev) => {
      if(ev.key === "1") choose(0);
      if(ev.key === "2") choose(1);
      if(ev.key === "3") choose(2);
      if(ev.key === "4") choose(3);
      if(ev.key === "Enter") next();
      if(ev.key === "r" || ev.key === "R") buildDeck();
    });

    // init
    ui.playerName.value = (activeName === "Visitante") ? "" : activeName;
    refreshPlayerUI();
    render();

    console.log("GeoAgro Quiz BR pronto. Bank =", bank.length);
  })();
  </script>
</body>
</html>
